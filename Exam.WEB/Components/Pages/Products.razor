@page "/products"
@rendermode InteractiveServer
@using Exam.CORE.Models
@using Exam.BLL.Services
@inject ProductService ProductService

<div style="padding: 20px; font-family: Arial;">
    <h1>Онлайн Аптека</h1>

    <div style="margin: 20px 0;">
        <a href="/" style="margin-right: 15px;">Главная</a>
        <a href="/products" style="margin-right: 15px;">Товары</a>
        <a href="/orders" style="margin-right: 15px;">Заказы</a>
    </div>

    <hr />

    <h3>Список товаров</h3>

    @if (isLoading)
    {
        <p>Загрузка товаров...</p>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div style="color: red; padding: 10px; border: 1px solid red;">
            <strong>Ошибка:</strong> @errorMessage
        </div>
    }
    else if (products == null || !products.Any())
    {
        <p>Товары не найдены</p>
    }
    else
    {
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="border: 1px solid #ddd; padding: 8px;">ID</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Название</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Цена</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in products)
                {
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">@product.Id</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">@product.Name</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">@product.Price.ToString("C")</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <button @onclick="() => EditProduct(product)"
                                    style="padding: 5px 10px; margin-right: 5px;">
                                Изменить
                            </button>
                            <button @onclick="() => DeleteProduct(product.Id)"
                                    style="padding: 5px 10px;">
                                Удалить
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <div style="margin-top: 20px; padding: 15px; border: 1px solid #ddd;">
        <h4>@(editingProduct?.Id == 0 ? "Добавить товар" : "Изменить товар")</h4>
        <div style="margin-bottom: 10px;">
            <label>Название:</label>
            <input @bind="editingProduct.Name" style="margin-left: 10px; padding: 5px;" />
        </div>
        <div style="margin-bottom: 10px;">
            <label>Цена:</label>
            <input @bind="editingProduct.Price" type="number" style="margin-left: 10px; padding: 5px;" />
        </div>
        <button @onclick="SaveProduct"
                style="padding: 8px 15px;">
            Сохранить
        </button>
    </div>
</div>

@code {
    private List<Product> products = new();
    private Product editingProduct = new();
    private string errorMessage = string.Empty;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            products = await ProductService.GetAllProductsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка загрузки: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void EditProduct(Product product)
    {
        editingProduct = new Product { Id = product.Id, Name = product.Name, Price = product.Price };
    }

    private async Task SaveProduct()
    {
        try
        {
            if (editingProduct.Id == 0)
            {
                await ProductService.AddProductAsync(editingProduct);
            }
            else
            {
                await ProductService.UpdateProductAsync(editingProduct);
            }

            editingProduct = new Product();
            await LoadProducts();
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка сохранения: {ex.Message}";
        }
    }

    private async Task DeleteProduct(int id)
    {
        try
        {
            await ProductService.DeleteProductAsync(id);
            await LoadProducts();
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка удаления: {ex.Message}";
        }
    }
}